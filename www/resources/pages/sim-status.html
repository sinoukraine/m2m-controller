<!--suppress JSAnnotator -->
<template>
	<div data-name="sim-status" class="page"> <!-- page-with-subnavbar -->
		<!-- Top Navbar -->
		<div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="back link icon-only " >
                        <i class="icon material-icons">arrow_back</i>
                    </a>
                </div>
                <div class="title sliding">
                    SIM Status
                </div>
            </div>
        </div>
		
		<div class="page-content">
			<div class="inner-content">
				<div class="sim-status-top">
					<img class="sim-icon" src="./resources/images/sim.svg" alt="main">
					<div class="sim-status-top-info">
						<div class="text-content">IMSI: {{IMSI}}</div>
						<div class="text-content">ICCID: {{ICCID}}</div>
					</div>
				</div>
				<div class="content-block status_block_top">
					<div class="row no-gutter status_block_icons">
						<div class="col-33 ">
							<img src="resources/images/data.svg" alt="">
							<p>{{dataInfo}} MB</p>
						</div>                
						<div class="col-33">
							<img src="resources/images/date.svg" alt="">
							<p>{{dateInfo}}</p>
							
						</div> 
						<div class="col-33">
							<img src="resources/images/messages.svg" alt="">
							<p>{{messagesInfo}}</p>                    
						</div>               
					</div>
				</div>
				
				
				
				<div class="item-inner">
					<ul class="additional-sim-info-ul"><!--
						<li class="item-content additional-sim-info">
							<div class="item-media"></div>
							<div class="item-title label additional-sim-label">Customer</div>
							<div class="item-input dflex item-input-field">
								<div class="item-title label">Ag Tracking</div>
								<i class="material-icons md-36 select_arrow">arrow_drop_down</i>
							</div>
						</li>-->
						<li class="item-content additional-sim-info">
							<a href="#" class="currentState">
								<div class="item-media"></div>
								<div class="item-title label additional-sim-label">State</div>
								<div class="item-input dflex item-input-field">
									<div class="item-title label">{{statusInfo}}</div>
									<i class="material-icons md-36 select_arrow">arrow_drop_down</i>
								</div>
							</a>
						</li>
							
					</ul>
					<div class="location-div">
						<button class="col button button-outline currentLocation">Show location</button>
					</div>
                </div>
			</div>
		</div>
    </div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				dataInfo: 0,
				dateInfo: 0,
				messagesInfo: 0,
				statusInfo: ''
			};            
            
			if (self.$route.query.imsi) {
				ret.IMSI = self.$route.query.imsi;
            }  			
            
			if (self.$route.query.iccid) {
				ret.ICCID = self.$route.query.iccid;
            }  			
            return ret;
        },
		methods: {
			loadTrackPage: function () {
			
				var self = this;
				
				$.ajax({
						type: "GET",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI + '/coordinates?formula=centerOfMass', 
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
							
								console.log(result);
								var lat = result.geometry.coordinates[0], lng = result.geometry.coordinates[1];
								
								
								
				
								if (lat !== 0 && parseFloat(lng) !== 0) {            
										
									var boatMarker = L.icon({
										iconUrl: 'resources/images/marker.svg',                       
										iconSize:     [50, 50], // size of the icon                        
										iconAnchor:   [50, 99], // point of the icon which will correspond to marker's location                        
										popupAnchor:  [0, -50] // point from which the popup should open relative to the iconAnchor    
									});

									var marker = L.marker([lat, lng], {icon: boatMarker}); 
									marker.setLatLng([lat, lng]);
									MapTrack = Protocol.Helper.createMap({ target: 'map', latLng: [lat,lng], zoom: 14 });        
									marker.addTo(MapTrack);
									
									self.$app.preloader.hide();
								}
								
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
			},
			initSimInfo: function () {
                let self = this;
									
					$.ajax({
						type: "GET",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI + '/sms', 
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
								var dates = [];
								
								$.each(result, function(index, value){										
									dates.push(new Date(value.insertedDate));
								});
									
								var maxDate = new Date(Math.max.apply(null, dates));
								var maxDate = moment.utc(maxDate).toDate();
									maxDate = moment(maxDate).format(window.COM_TIMEFORMAT);
													
								self.$setState({
									dateInfo: maxDate.substr(0, maxDate.length - 6).replace("T", " "),
								});	
								
								self.$setState({
									messagesInfo: result.length,
								});		
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
					$.ajax({
						type: "GET",		        
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v2/cdrs/'+ self.IMSI, 
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
								var total = 0;
								
								$.each(result, function(index, value){										
									var mb = 0;
									if(value.totals != null && value.totals.data != null && value.totals.data.originalUnits != null){
										mb = value.totals.data.originalUnits;
									}
									total = total + mb;
								});
								
								self.$setState({
									dataInfo: (total/1000000).toFixed(3),
								});
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
					$.ajax({
						type: "GET",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI, 
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
								self.$setState({
									statusInfo: result.status
								});														
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
            }
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;        
				self.$app.preloader.show();	

				
				
				var dynamicPopup = self.$app.popup.create({
								  content: '<div class="page popup-tablet-fullscreen popup">'+
										'<div class="page-content">'+
										'	<div class="position_map "> '+
										'		<div class="map" id="map"></div>'+
										'	</div>'+
										'</div>'+
									'</div>',
								  on: {
									open: function (popup) {									
									  console.log('Popup open');
										self.loadTrackPage();
										
									},
									opened: function (popup) {
									  console.log('Popup opened');
									},
								  }
								});
				
					 
				
				var thisPage = page.$el.find('.page-content'); 			

                self.initSimInfo();
				self.$app.preloader.hide();
				
				$('.currentState').on('click', function(){						
					mainView.router.navigate('/set-status/?imsi='+self.IMSI);
				});
				
				$('.currentLocation').on('click', function(){		
					
					
					self.$app.preloader.show();
					dynamicPopup.open();
							
				});
				
				
				
			}
		}
    };
</script>
    