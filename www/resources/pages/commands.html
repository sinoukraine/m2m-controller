<!--suppress JSAnnotator -->
<template>
	<div data-name="commands" class="page"> <!-- page-with-subnavbar -->
		<!-- Top Navbar -->
		<div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="back link icon-only " >
                        <i class="icon material-icons">arrow_back</i>
                    </a>
                </div>
                <div class="title sliding imsi-title">
					{{imsi}}
                    <!-- 234507098430582-->
                </div>
                <div class="right">
                    <a href="/commands-list/?imsi={{imsi}}" class="link icon-only cmdList">
                        <i class="material-icons md-36">list</i>
                    </a>
                </div>
            </div>
        </div>
		
		<div class="toolbar messagebar">
		  <div class="toolbar-inner">
			<div class="messagebar-area">
			  <!-- messagebar attachments -->
			  <div class="messagebar-attachments">...</div>
			  <!-- messagebar resizable textarea -->
			  <textarea class="resizable" placeholder="Command">{{selectedCmd}}</textarea>
			</div>
			<a href="#" class="link send-link"><i class="icon material-icons">send</i></a>
		  </div>
		  <!-- messagebar sheet -->
		  <div class="messagebar-sheet">...</div>
		</div>

		<div class="page-content messages-content">
		<div class="messages">
		  <!-- Date stamp -->
		  <div class="messages-title"></div>

		</div>
	  </div>
	</div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				intervalForReply: {},
				responseInProgress: false,
				messages: {},
				messagebar: {},
				allowInfinite: true,
				isSent: false,
				page: 1,
				lastItemIndex: 0,
				maxItems: 0,
				month_names_short: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
				used_id: [],
				//customCmd: '',
				dynamicPopup: {}
			};     
			
            if (self.$route.query.id) {
				ret.ID = self.$route.query.id;
            }  		
			
			if (self.$route.query.selectedCmd) {
				ret.selectedCmd = self.$route.query.selectedCmd;
            }  	
			if (self.$route.query.imsi) {
				ret.imsi = self.$route.query.imsi;
            }  	

            return ret;
        },		
        methods: {
            sendCommand: function(text){					
				var self = this;  
				//var text = data;	
				var data = {
					/*"smsParameters": {
						"data": text,
						"from": "Platform",
						"replaceIfPresent": "No",
						"smsType": "Text",
						"smsValidityDays": "1",
						"smsValidityHours": "1",
						"smsValidityMinutes": "2",
						"udh": "No"
					}*/
					"content": text
				}
				
				
					let userInfo = self.$app.methods.getFromStorage('userInfo');
					let accessToken = userInfo.accessToken;
					
				//console.log(data, "http://m2mdata03.sinopacific.com.ua/api/v3/sims/" + self.imsi + "/sms");
				console.log('emit sending message');
				$.ajax({
					async: true,
					crossDomain: true,
					url: "http://m2mdata03.sinopacific.com.ua/api/v3/sims/" + self.ID + "/sms",
					method: "POST",
					headers: {
						Authorization: "Bearer " + accessToken,
						"content-type": "application/json"
					},
					processData: false,
					data: JSON.stringify(data),
					success: function (result) {
						//self.receiveMessage(text, result.orderId);
						//self.getReplyMessages(text, result.orderId);
						console.log(result);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
					}
				});	
				
				
            },
			getReplyMessages: function () {					
					var d = new Date();
				
					let self = this;
					//var curDate = d.toISOString().substr(0, 11) + '00:00:00.000Z';
					var curDate = '2020-12-13T00:00:00.000Z';
						
				let userInfo = self.$app.methods.getFromStorage('userInfo');
				let accessToken = userInfo.accessToken;		
				
					console.log(curDate);
					$.ajax({
						type: "GET",
						url: 'https://m2mdata03.sinopacific.com.ua/nomad/sims/' + self.imsi + '/sms',
						//url: 'https://m2mdata03.sinopacific.com.ua/api/v3/sims/' + self.ID + '/sms?startDate=' + curDate + '&pageSize=100',		        
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "Bearer " + accessToken,
						},
						success: function (result) {//console.log(result);
							if (result) {
								let sortedRes = result.sort(function(a,b){
									var c = new Date(a.insertedDate);
									var d = new Date(b.insertedDate);
									return d-c;
								});
								self.setReplyMessages(sortedRes.reverse());
							
							} else {
								//App.alert(LANGUAGE.PROMPT_MSG013);
								//self.$app.dialog.alert('delivering...');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
								//self.$app.dialog.alert('erroring...');
						}
					});				
			},
			setReplyMessages: function (callbackList) { console.log(callbackList);
                let self = this;
				
				var html = '';
				$.each(callbackList, function(index, value){				
					if(self.used_id.indexOf( value.insertedDate ) == -1){
					
						self.used_id.push(value.insertedDate);
						var datetime = moment.utc(value.insertedDate).toDate();
							//datetime = moment(datetime).format(window.COM_TIMEFORMAT);
							
						var time = datetime.getDate() + ' ' + self.month_names_short[datetime.getMonth()] + ' ' + ('0' + datetime.getHours()).slice(-2) + ':' + ('0' + datetime.getMinutes()).slice(-2) + ':' + ('0' + datetime.getSeconds()).slice(-2);
						var replySMS;
						
						if (value.message) {
								replySMS = value.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
							}
							
							if(value.direction == 'Outbound'){
								self.messages.addMessage({
									text: replySMS,
									textFooter: time,	
									attrs: {
										'data-id': value.insertedDate,	
									}								
								  });
								  
								$('[data-id="'+value.insertedDate+'"]').find('.message-bubble').prepend('<div class="msg-status">Delivered</div>');
											
								  if(value.status == 'Delivered' || value.status == 'Submitted'){
									$('.message-sent').each(function(i, ele) {
										//var x = document.getElementsByClassName("message-sent");
										console.log(value.status,datetime.getTime(), $(this).data('id'));
										//datetime.getTime() >= $(this).data('id')
										if(replySMS === $(this).find('.message-text').text() && $(this).find('.message-bubble').find('.msg-status').text() != 'Delivered'){
											$(this).remove();
											 //return false;
										}
									})
								  }
								  
								  
								
							}
							
						if(value.direction == 'Inbound'){
							
							//replySMS += ' (' + datetime + ')';
							
							//setTimeout(function () {		

							
								  self.messages.addMessage({
									text: replySMS,
									type: 'received',
									textFooter: time,	
									attrs: {
										'data-id': value.insertedDate,	
									}								
								  });
							//}, 5000);
						}/*else if(!self.isSent ){		//|| value.status == 'delivered'
							// Add message to messages
							self.messages.addMessage({
									text: replySMS,
									textFooter: time,	
									attrs: {
										'data-id': value._id,	
									}								
								  });
						}			*/

$('.page-content').scrollTop(10000, 400);						
						
					}
					/*if(self.used_id.indexOf( value._id ) == -1 ){
						self.used_id.push(value._id);
						var datetime = moment.utc(value.createdAt).toDate();
							//datetime = moment(datetime).format(window.COM_TIMEFORMAT);
							
						var time = datetime.getDate() + ' ' + self.month_names_short[datetime.getMonth()] + ' ' + ('0' + datetime.getHours()).slice(-2) + ':' + ('0' + datetime.getMinutes()).slice(-2) + ':' + ('0' + datetime.getSeconds()).slice(-2);
						var replySMS;
						
						if (value.message) {
							replySMS = value.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
						}else{
							replySMS = value.status;
						}
						//replySMS += ' (' + datetime + ')';
						
						//setTimeout(function () {				
							  self.messages.addMessage({
								text: replySMS,
								type: 'received',
								textFooter: time,	
								attrs: {
									'data-id': value._id,	
								}								
							  });
						//}, 5000);
					}*/
				});
			},
			/*receiveMessage: function(text, id){					
				var self = this;  
				
				var orderId = id;
						//console.log('https://m2mdata03.sinopacific.com.ua/api/v3/sims/orders/'+orderId);
				$.ajax({
					type: "GET",
					url: 'https://m2mdata03.sinopacific.com.ua/api/v3/sims/orders/'+orderId,
					dataType: "json",	
					async: true,
					headers: { 
						Authorization: "12345"
					},
					cache: false,
					success: function (result) {
						//console.log(result);
						self.$setState({
							responseInProgress: true,
						});
					  setTimeout(function () {
						var answer = text + ': ' + result.status;
						
						setTimeout(function () {
						  // Add received dummy message
						  self.messages.addMessage({
							text: answer,
							type: 'received',
						  });
						  self.$setState({
							responseInProgress: false,
						});
						}, 20000);
					  }, 10000);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
					}
				});
				
			},*/
			showCommandsList: function () {
                let self = this;
				
					$$('.commandsList ul').html('');
					
					self.$setState({
						page: 1
					});
					
					self.getCommandsList();
					self.$app.infiniteScroll.create('.infinite-scroll-content');	
					
				//} else {
					/*App.addNotification({
						hold: 3000,
						message: LANGUAGE.PROMPT_MSG008
					});*/
				//}		
			},						
			getCommandsList: function () {
                let self = this;
					if (!self.allowInfinite) return;					
					
					// Set loading flag
					self.$setState({
                        allowInfinite: false
                    });
					//self.$app.preloader.show();
					$.ajax({
						type: "GET",		        
						//url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims?page=' + self.page + '&pageSize=10&query%5Binfo.' + self.type + '%5D%5B%24regex%5D=' + self.text,
						url: 'http://m2mdata03.sinopacific.com.ua/em/v3/sms?page=' + self.page + '&pageSize=100',
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if (result.rows) {
								//$$('.page-content').removeClass('first_login');
																	
								if(result.page == 1){
									
									self.$app.infiniteScroll.create('.infinite-scroll-content');
									// Loading flag

									self.$setState({
										maxItems: result.total,
										lastItemIndex: $$('.commandsList li').length,										
									});
								}
							
									// Reset loading flag
									self.$setState({
										allowInfinite: true
									});
								
								self.setCommandsList(result.rows);
								
								//if (self.lastItemIndex >= self.maxItems) {
								if (result.page === result.totalPages) {
								  self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
								}
																		
								let incrList = self.lastItemIndex + 10;
								
								self.$setState({
									lastItemIndex: incrList
								});
								
								let incr = self.page + 1;
								
								self.$setState({
									page: incr
								});
									
								//$('.searchbar-hide-on-search').addClass('display-none');
																
								if(self.page == 2){
									$$('.infinite-scroll-content').on('infinite', self.getCommandsList);
								}
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
								//App.alert(LANGUAGE.PROMPT_MSG013);
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});				
			},
			setCommandsList: function (commandsList) {
                let self = this;
				// Generate new items HTML
				var html = '';
				
				$.each(commandsList, function(index, value){	
					html += '<li class="li-cmd">';//<a href="/commands/?cmd=' + value.content + '" class="link">
					html += '	  <div class="item-content">';
					html += '		<div class="item-inner">';
					html += '		  <div class="item-title cmd" cmd-name="' + value.content + '">' + value.name + '</div>';
					html += '		  <a href="/edit-command/?id=' + value._id + '" class="popup-close"><div class="item-after"><i class="material-icons md-24">create</i></div></a>';
					html += '		</div>';
					html += '	  </div>';	//	</a>			
					html += '</li>';
				});
								
				// Append new items
				$$('.commandsList ul').append(html);	
				$$('.commandsList ul .li-cmd').on('click', function(){	
					let command = $(this).find('.cmd').attr('cmd-name');
					self.messagebar.setValue(command);
					//self.$update();
					
					/*self.$setState({
						customCmd: command,
					});		*/
					self.dynamicPopup.close();	
				});				
			},	
		},
        on: {
            pageInit: function (e, page) {  
				var self = this; 
				
				
				
				// Init Messages
				self.messages = app.messages.create({
				  el: '.messages',

				  // First message rule
				  firstMessageRule: function (message, previousMessage, nextMessage) {
					// Skip if title
					if (message.isTitle) return false;
					/* if:
					  - there is no previous message
					  - or previous message type (send/received) is different
					  - or previous message sender name is different
					*/
					if (!previousMessage || previousMessage.type !== message.type || previousMessage.name !== message.name) return true;
					return false;
				  },
				  // Last message rule
				  lastMessageRule: function (message, previousMessage, nextMessage) {
					// Skip if title
					if (message.isTitle) return false;
					/* if:
					  - there is no next message
					  - or next message type (send/received) is different
					  - or next message sender name is different
					*/
					if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
					return false;
				  },
				  // Last message rule
				  tailMessageRule: function (message, previousMessage, nextMessage) {
					// Skip if title
					if (message.isTitle) return false;
					  /* if (bascially same as lastMessageRule):
					  - there is no next message
					  - or next message type (send/received) is different
					  - or next message sender name is different
					*/
					if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
					return false;
				  }
				});

				// Init Messagebar
				self.messagebar = app.messagebar.create({
				  el: '.messagebar'
				});			
				//<b>Friday, Feb 17</b> 12:58
				var today = new Date();
				$$('.messages-title').html(today);
				//self.messagebar = page.$el.find('.messagebar'); 
				$$('.send-link').on('click', function () {
                //self.messagebar.on('click', '.send-link', function(e){      
					//self.sendCommand();
					
					
					var text = self.messagebar.getValue().replace(/\n/g, '<br>').trim();
					//console.log(self.messagebar.getValue());
					  // return if empty message
					  if (!text.length) return;

					  // Clear area
					  self.messagebar.clear();

					  // Return focus to area
					  self.messagebar.focus();

					  const timesent = new Date().getTime()-1000;
					  // Add message to messages
					  self.messages.addMessage({
						text: text,
						attrs: {
							'data-id': timesent,
						  }
					  });
					  
					  
$('.page-content').scrollTop(10000, 400);
					  self.$setState({
						isSent: true,
					});
							
					self.sendCommand(text);
					
					$('[data-id="'+timesent+'"]').find('.message-bubble').prepend('<div class="msg-status">Sent...</div>');
					
				});
				
						if(!self.responseInProgress){
							self.getReplyMessages();
							self.$setState({
								responseInProgress: true,
							});
						}
						
						self.intervalForReply = setInterval(function () {		
							self.getReplyMessages();
						}, 30000);				
						
				
				
			
				
			
				
				/*
				self.dynamicPopup = self.$app.popup.create({
								  content: 
									  '<div class="popup"><div class="navbar">'+
										'<div class="navbar-bg"></div>'+
										'<div class="navbar-inner">'+
											'<div class="left">'+
												'<a href="#" class="link icon-only popup-close" >'+
													'<i class="icon material-icons">arrow_back</i>'+
												'</a>'+
											'</div>'+
											'<div class="right">'+
												'<a href="/add-command/?imsi=' + self.imsi + '" class="link icon-only popup-close add-cmd">'+
													'<i class="material-icons md-36">add</i>'+
												'</a>'+
											'</div>'+
										'</div>'+
									'</div>'+
									'<div class="page-content  ">'+	// ptr-content	
										*'<div class="ptr-preloader">'+
													'<div class="preloader"></div>'+
													'<div class="ptr-arrow"></div>'+
										'</div>'+*
										'<div class="block searchbar-hide-on-search">'+
											'<h3>Commands List</h3>'+
											'<p>In this screen, you can send different commands to test this device</p>		'+		
										'</div><div class="list">'+
										'<div class="list command-list-icons commandsList ">'+
													'<ul>'+
													'</ul>'+
													'</div>'+
													'<div class="preloader infinite-scroll-preloader"></div>'+
											*'<ul>'+
											'<li class="accordion-item"><a href="#" class="item-content item-link">'+
												'<div class="item-inner">'+
												  '<div class="item-title">Demo list</div>'+
												'</div></a>'+
												'<div class="accordion-item-content accordion-item-opened ">'+						
													
												'</div>'+
											'</li>'+
											'</ul>'+*
										'</div>'+
									'</div>'+	
									'</div>',	
			
								  on: {
									open: function (popup) {									
									  //console.log('Popup open');
									  self.showCommandsList();
									},
									opened: function (popup) {
									  //console.log('Popup opened');
									},
								  }
								});
								
				$('.cmdList').on('click', function(){		
					self.dynamicPopup.open();							
				});*/
			
				/*$('.cmdList').on('click', function(){		
					mainView.router.navigate('/commands-list/?imsi=' + self.imsi);
				});*/
				
				myEvents.on('cmdReceived', function (data) {					
					self.messagebar.setValue(data.cmd);		
					//$$('.send-link').click();			
				});
			},
			pageBeforeRemove: function () {
				var self = this; 
				
                myEvents.off('cmdReceived');
				clearInterval(self.intervalForReply);
            },
            pageBeforeOut:function(){
				var self = this; 				
				
				//clearInterval(self.intervalForReply);
            },
		}

    };
</script>