<!--suppress JSAnnotator -->
<template>
	<div data-name="commands" class="page"> <!-- page-with-subnavbar -->
		<!-- Top Navbar -->
		<div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="my-back-home link icon-only " >
                        <i class="icon material-icons">arrow_back</i>
                    </a>
                </div>
                <div class="title sliding imsi-title">
					{{imsiTitle}}
                    <!-- 234507098430582-->
                </div>
                <div class="right">
                    <a href="/commands-list/" class="link icon-only ">
                        <i class="material-icons md-36">list</i>
                    </a>
                </div>
            </div>
        </div>
		
		<div class="toolbar messagebar">
		  <div class="toolbar-inner">
			<div class="messagebar-area">
			  <!-- messagebar attachments -->
			  <div class="messagebar-attachments">...</div>
			  <!-- messagebar resizable textarea -->
			  <textarea class="resizable" placeholder="Command">{{cmd}}</textarea>
			</div>
			<a href="#" class="link send-link"><i class="icon material-icons">send</i></a>
		  </div>
		  <!-- messagebar sheet -->
		  <div class="messagebar-sheet">...</div>
		</div>

		<div class="page-content messages-content">
		<div class="messages">
		  <!-- Date stamp -->
		  <div class="messages-title"></div>

		</div>
	  </div>
	</div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				responseInProgress: false,
				messages: {},
				messagebar: {},
			};     

			if (self.$route.query.imsi) {
				ret.imsiTitle = self.$route.query.imsi;
            }  	

			if (self.$route.query.cmd) {
				ret.cmd = self.$route.query.cmd;
            }  				
            
			/*console.log(self.$route.query.code);
			if (self.$route.query.code) {
				ret.PhotoPath = self.$route.query.code;
            }*/

            return ret;
        },		
        methods: {
            sendCommand: function(data){					
				var self = this;  
				var text = data;		
				var data = {
					"smsType": "Text",
					"data": text,
					"udh": "No",
					"replaceIfPresent": "No",
					"smsValidityDays": "1",
					"smsValidityHours": "1",
					"smsValidityMinutes": "2"
				}
				
				/*var question = data.data;
						setTimeout(function () {
						  self.messages.addMessage({
							text: question,
							type: 'sent',
						  });
					*/
				$.ajax({
					async: true,
					crossDomain: true,
					url: "http://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims/" + self.imsiTitle + "/sms",
					method: "POST",
					headers: {
						"authorization": "12345",
						"content-type": "application/json"
					},
					processData: false,
					data: JSON.stringify(data),
					success: function (result) {
						self.receiveMessage(text, result.orderId);
						
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
					}
				});
				
						
            },
			receiveMessage: function(text, id){					
				var self = this;  
				
				var orderId = id;
						console.log('https://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims/orders/'+orderId);
				$.ajax({
					type: "GET",
					url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims/orders/'+orderId,
					dataType: "json",	
					async: true,
					headers: { 
						Authorization: "12345"
					},
					cache: false,
					success: function (result) {
						//console.log(result);
						self.$setState({
							responseInProgress: true,
						});
					  setTimeout(function () {
						var answer = text + ': ' + result.status;
						
						setTimeout(function () {
						  // Add received dummy message
						  self.messages.addMessage({
							text: answer,
							type: 'received',
						  });
						  self.$setState({
							responseInProgress: false,
						});
						}, 20000);
					  }, 10000);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
					}
				});
				
			}
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;              
			
				
				
				
				
				// Init Messages
				self.messages = app.messages.create({
				  el: '.messages',

				  // First message rule
				  firstMessageRule: function (message, previousMessage, nextMessage) {
					// Skip if title
					if (message.isTitle) return false;
					/* if:
					  - there is no previous message
					  - or previous message type (send/received) is different
					  - or previous message sender name is different
					*/
					if (!previousMessage || previousMessage.type !== message.type || previousMessage.name !== message.name) return true;
					return false;
				  },
				  // Last message rule
				  lastMessageRule: function (message, previousMessage, nextMessage) {
					// Skip if title
					if (message.isTitle) return false;
					/* if:
					  - there is no next message
					  - or next message type (send/received) is different
					  - or next message sender name is different
					*/
					if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
					return false;
				  },
				  // Last message rule
				  tailMessageRule: function (message, previousMessage, nextMessage) {
					// Skip if title
					if (message.isTitle) return false;
					  /* if (bascially same as lastMessageRule):
					  - there is no next message
					  - or next message type (send/received) is different
					  - or next message sender name is different
					*/
					if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
					return false;
				  }
				});

				// Init Messagebar
				self.messagebar = app.messagebar.create({
				  el: '.messagebar'
				});			
				//<b>Friday, Feb 17</b> 12:58
				var today = new Date();
				$$('.messages-title').html(today);
				//self.messagebar = page.$el.find('.messagebar'); 
				$$('.send-link').on('click', function () {
                //self.messagebar.on('click', '.send-link', function(e){      
					//self.sendCommand();
					
					
					var text = self.messagebar.getValue().replace(/\n/g, '<br>').trim();
					  // return if empty message
					  if (!text.length) return;

					  // Clear area
					  self.messagebar.clear();

					  // Return focus to area
					  self.messagebar.focus();

					  // Add message to messages
					  self.messages.addMessage({
						text: text,
					  });
					self.sendCommand(text);

				});
				
				/*myEvents.on('cmdReceived', function (data) {
					
					self.messagebar.setValue('778');
					self.$update();
					
					//
					//page.$pageEl.find('textarea').val('777');
					//console.log(self.messagebar);
				});
				*/
				
				$$('.my-back-home').on('click', function () {
					page.view.router.back({
						url: 'home',
						force: true,
						ignoreCache: true
					});
					//app.views.main.router.navigate('/home/', {reloadAll: true})
				});
	
			},
			pageBeforeRemove: function () {
                myEvents.off('cmdReceived');
            }
		}

    };
</script>
    