<!--suppress JSAnnotator -->
<template>
	<div data-name="commands-history" class="page"> <!-- page-with-subnavbar -->
		<!-- Top Navbar -->
		<div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="back link icon-only " >
                        <i class="icon material-icons">arrow_back</i>
                    </a>
                </div>
                <div class="title sliding">
                    Commands History
                </div>
            </div>
        </div>
		
		<div class="page-content ">
			<div class="block searchbar-hide-on-search">
				<h3>{{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG02}}</h3>
                <p>{{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG03}}</p>				
            </div>
			<!--<div class="list">
				<input type="hidden" name="IMSI" value="{{IMSI}}">
				<input type="hidden" name="LastDay" value="1">
			  <ul>
            
                <li class="item-content border_bottom">
                    <div class="item-inner display-block">
                        <div class="item-title label">{{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG06}}</div>
                        <div class="item-input">
                            <select name="LastDaySelect" data-set="{{LastDay}}">                 
								<option value="1">1 day</option>
								<option value="2">3 days</option>
								<option value="7">1 week</option>
								<option value="14">2 weeks</option>
								<option value="30">1 month</option>
								<option value="60">2 months</option>
								<option value="3000">all time</option>
                                <option value="1">1 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG04}}</option>
                                <option value="2">2 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                                <option value="3">3 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                                <option value="4">4 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                                <option value="5">5 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="6">6 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>                                
                                <option value="7">7 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="8">8 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="9">9 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="10">10 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="11">11 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="12">12 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="13">13 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="14">14 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                            </select>
                            <i class="f7-icons icon-arrow-drop-down select_arrow"></i>
                        </div>
                    </div>
                </li>
            </ul>
        </div>-->

		
        <div class="list virtual-list home-list commandsHistoryList" style="margin: 0">
         
        </div>
		<!--<div class="preloader infinite-scroll-preloader"></div>-->
    </div>
</div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				oldHistoryArray: [],
				virtualCommandsHistoryList: false,
				allowInfinite: true,
				page: 1,
				lastItemIndex: 0,
				maxItems: 0,
				used_id: [],
				VirtualHistoryList: {},
				month_names_short: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
			};            
            
			if (self.$route.query.imsi) {
				ret.IMSI = self.$route.query.imsi;
            }  			
            
            return ret;
        },
		methods: {
			requestCommandHistory: function(list){	
				var self = this;
				self.$app.preloader.hide();
				/*if (params && params.IMSI && params.LastDay) {
					var data = {
						IMSI: self.IMSI,
						LastDay: params.LastDay,
					};

					var container = $$('body');
					if (container.children('.progressbar, .progressbar-infinite').length) return; //don't run all this if there is a current progressbar loading
					//App.showProgressbar(container);
					
					$.ajax({
						type: "GET",
						url: API_URL.URL_GET_COMMAND_HISTORY + data.IMSI + '/sms',        
						dataType: "json",	
						headers: { 
							Authorization: "12345"
						},
						async: true,
						cache: false,
						success: function (result) {
							if(result){				
								
									if (result) {
										*/
										var listEl = self.$el.find('.commandsHistoryList');
										/*
										if (self.virtualCommandsHistoryList) {
											self.virtualCommandsHistoryList.destroy();
										}*/
										
										//result.length = 5;
										
										self.virtualCommandsHistoryList = self.$app.virtualList.create({
                    el: listEl,
                    items : [],
                    //cache: false,
                    //showFilteredItemsOnly: true,
                    /*searchAll: function (query, items) {
                        let filterType = this.el.data('filter-type');
                        let filteredListIndexes = self.$app.methods.filterAssetList(items, filterType);
                        let found = [];

                        for (let i = 0; i < filteredListIndexes.length; i++) {
                            if (items[filteredListIndexes[i]].Name.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(filteredListIndexes[i]);
                        }

                        return found; //return array with mathced indexes
                    },*/
                    height: function(item){
                        let height = 65.33;
                        /*let afs = Protocol.Helper.getAssetStateInfo(POSINFOASSETLIST[item.IMEI]);
                        if (afs && afs.stats) {
                            height = 164.63;
                            if (afs.voltage && afs.fuel || afs.battery && afs.fuel || afs.battery && afs.voltage) {
                                height = 192.94;
                            }
                        }*/
                        return height;
                    },
                    renderItem: function (item, index) {console.log(item);
									let html = '';
									var datetime = moment.utc(item.insertedDate).toDate();
												datetime = moment(datetime).format(window.COM_TIMEFORMAT);

												
												if (item.message) {
													item.message = item.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
												}

												if (item.direction == 1) {
													html += '<li class="item-content with-divider-bottom" >';
												} else {
													html += '<li class="item-content" >';
												}
												html += '<div class="item-inner item-inner-commands-history">';
												html += '<div class="item-title-row">';
												html += '<div class="item-title">';
												if (item.direction == 'Inbound') {
													html += '<i class="material-icons md-36">email</i>';
												} else {
													html += '<i class="material-icons md-36">send</i>';
												}
												html += '</div>';
												html += '<div class="item-after">' + datetime + '</div>';
												html += '</div>';
												html += '<div class="item-text">' + item.message + '</div>';
												html += '</div>';
												html += '</li>';
												return html;

						
						
						
												
												/*
												var datetime = moment.utc(item.insertedDate).toDate();
												datetime = moment(datetime).format(window.COM_TIMEFORMAT);

												
												if (item.message) {
													item.message = item.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
												}

												if (item.direction == 1) {
													html += '<li class="item-content with-divider-bottom" >';
												} else {
													html += '<li class="item-content" >';
												}
												html += '<div class="item-inner item-inner-commands-history">';
												html += '<div class="item-title-row">';
												html += '<div class="item-title">';
												if (item.direction == 'Inbound') {
													html += '<i class="material-icons md-36">email</i>';
												} else {
													html += '<i class="material-icons md-36">send</i>';
												}
												html += '</div>';
												html += '<div class="item-after">' + datetime + '</div>';
												html += '</div>';
												html += '<div class="item-text">' + item.message + '</div>';
												html += '</div>';
												html += '</li>';
												return ret;*/
											}
										});
										
										self.virtualCommandsHistoryList.replaceAllItems(list);
									/*} else {
									
										if (self.virtualCommandsHistoryList) {
											self.virtualCommandsHistoryList.deleteAllItems();
										}
									}
							
								//console.log(result);
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
				}*/
			},
			getOldHistory: function () {
				let self = this;
				self.$app.preloader.show();
				$.ajax({
						type: "GET",		        
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims/' + self.IMSI + '/sms?page=' + self.page + '&pageSize=100',//?startDate=2019-03-14T10:36:31.000Z&endDate=2019-03-17T12:26:05.000Z
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if (result.length) {
								/**/
								
								if(self.page > 1){
									self.oldHistoryArray= self.oldHistoryArray.concat(result);
								}else{
									self.oldHistoryArray= result;									
								}
															
								//console.log(self.oldHistoryArray);
								
								//if(self.page < 4){
									let incr = self.page + 1;
									
									self.$setState({
										page: incr
									});
									
									self.getOldHistory();
								//}								
							}						
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							//console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
							if(self.oldHistoryArray.length > 0){
								/*var arr = [];
								
								$.each(self.oldHistoryArray, function(index, value){
									arr[new Date(value.insertedDate).getTime()] = value;
								});
								
								arr.sort(function(o1,o2){
								  return sort_o1_before_o2 ? -1 : sort_o1_after_o2 ? 1 : 0;
								});
								
								console.log(arr);*/
								self.oldHistoryArray.sort(function(a,b){
									var c = new Date(a.insertedDate);
									var d = new Date(b.insertedDate);
									return d-c;
								});
								
								self.requestCommandHistory(self.oldHistoryArray);
								//console.log(self.oldHistoryArray);
							}	else{
								self.$app.preloader.hide();
								self.$app.dialog.alert('There are no history for this period');
							}
						}
					});
			},
			getCommandHistory: function (params) {
                let self = this;
				
				/*var input = $$('.formSearchSim input[name="searchInput"');*/

				//if (input.val()) {
					$$('.commandsHistoryList ul').html('');
				/*	input.blur();

					var searchby = input.data('searchby');

					var data = input.val().trim();
					*/
					self.$setState({
						page: 1
					});
					if (params && params.IMSI && params.LastDay) {
						/*var data = {
							IMSI: self.IMSI,
							LastDay: params.LastDay,
						};*/
						self.getHistoryList(params.LastDay);
						self.$app.infiniteScroll.create('.infinite-scroll-content');	
					}
				//} else {
					/*App.addNotification({
						hold: 3000,
						message: LANGUAGE.PROMPT_MSG008
					});*/
				//}		
			},						
			getCallbackList: function (date, index, curId) {
				let self = this;
				
				
				//var curDate = d.toISOString();//.substr(0, 11) + '00:00:00.000Z';

					
				var nextId = $$('.page').find('.commandsHistoryList ul [idx="' + (index - 1) + '"]').attr('id');
				var nextDate = $$('.page').find('.commandsHistoryList ul [idx="' + (index - 1) + '"] .sms-datetime').attr('date');	
				
				var curDate = date;//.slice(0,10).toString();
				
				if(nextDate == undefined) {
					var d = new Date();
					/*var m_names = new Array("01", "02", "03", 
					"04", "05", "06", "07", "08", "09", 
					"10", "11", "12"); 
					
					var today = d.getDate()+1; 
					var curr_month = d.getMonth();
					var curr_year = d.getFullYear();
					nextDate = curr_year + "-" + m_names[curr_month] + "-" + today;*/
					//nextDate = d.toISOString();
					var nextDate = d.toISOString().substr(0, 11) + '23:59:59.100Z';
					
				}
					$.each(self.oldHistoryArray, function(index, value){
						var nx = new Date(nextDate).getTime();
						
				//		console.log(value, index);						
					});
				
					//self.$app.preloader.show();
					$.ajax({
						type: "GET",		        
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/messages?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D=' + curDate + '&pageSize=100&sort=createdAt&query%5BcreatedAt%5D%5B%24lt%5D=' + nextDate,
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if (result.rows) {
								self.setCallbackList(result.rows, curId);
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
								App.alert(LANGUAGE.PROMPT_MSG013);
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});

					
			},
			setCallbackList: function (callbackList, curId) {
                let self = this;
				// Generate new items HTML
				var html = '';
				$.each(callbackList, function(index, value){	//console.log(value);
								
					if(value.status != 'delivered'){//self.used_id.indexOf( value._id ) == -1 && 
					//self.used_id.push(value._id);
					//console.log(value);
					/*var datetime = moment.utc(value.createdAt).toDate();
						datetime = moment(datetime).format(window.COM_TIMEFORMAT);*/
						var date = moment.utc(value.createdAt).toDate();
						var datetime = date.toISOString();
						var time = date.getDate() + ' ' + self.month_names_short[date.getMonth()] + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getSeconds()).slice(-2);
					//var datearr[index] = datetime;
					
					//var prevDate = $$('.page').find('.commandsHistoryList ul [ridx="' + (index - 1) + '"] .sms-datetime').html();
					/*if(index){						
						var prevDate = callbackList[index-1].createdAt.slice(0,10).toString();
						var currDate = callbackList[index].createdAt.slice(0,10).toString();						
						var p = new Date(prevDate);
						var c = new Date(currDate);
						var prev_date = p.getDate();		
						var prev_month = p.getMonth();
						var prev_year = p.getFullYear();
						var curr_date = c.getDate();		
						var curr_month = c.getMonth();
						var curr_year = c.getFullYear();
						
						if(prev_year + "-" + prev_month + "-" + prev_date != curr_year + "-" + curr_month + "-" + curr_date){
							html += '<li class="item-content with-divider-bottom" >';				
							html += '<div class="item-inner item-inner-commands-history">';
							html += '<div class="item-title-row">';
							html += '<div class="item-title">';	
							html += '</div>';
							html += '<div class="item-after sms-datetime" style="font-weight: bolder">' + curr_year + "/" + curr_month + "/" + curr_date + '</div>';					
							html += '</div>';
							html += '</div>';
							html += '</li>';	
						}
					}*/
					
					if (value.message) {
						value.message = value.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
					}

					//if (value.direction == 1) {
						html += '<li class="item-content with-divider-bottom" ridx="' + index + '">';
					//} else {
						//html += '<li class="item-content" >';
					//}
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					if (value.status == 'delivered') {
						html += '<i class="material-icons md-36">settings</i>';
					} else {
						html += '<i class="material-icons md-36 ">email</i>';
					}
						html += '</div>';
						html += '<div class="item-after ">' + time + '</div>';
						html += '</div>';
					if(value.message){
						html += '<div class="item-text">' + value.message + '</div>';
					}else{
						html += '<div class="item-text">' + value.status + '</div>';
					}
						html += '</div>';
						html += '</li>';		
					}
				});
				//console.log($('#sms-id_' + curId).html(), html);
				$('#sms-id_' + curId).after(html);		
			
		},
			getHistoryList: function (n) {
				
				var d = new Date();
				var m_names = new Array("01", "02", "03", 
					"04", "05", "06", "07", "08", "09", 
					"10", "11", "12");
					
				var today = d.getDate();  //change day here
				var nDaysAgo = d.getDate()-n;  //change day here
				var curr_month = d.getMonth();
				var curr_year = d.getFullYear();
				var ago = curr_year + "-" + m_names[curr_month] + "-" + nDaysAgo;
				var now = curr_year + "-" + m_names[curr_month] + "-" + today;
						
                let self = this;
					if (!self.allowInfinite) return;					
					
				  // Set loading flag
					self.$setState({
                        allowInfinite: false
                    });
					
					var nowFull = moment(); 
					/*var datetime = moment.utc(value.createdAt).toDate();
						datetime = moment(datetime).format(window.COM_TIMEFORMAT);*/
					var start = nowFull.add(-n, 'days');
					var ago = start.toISOString();
					
					//self.$app.preloader.show();start.format(window.COM_TIMEFORMAT)
					$.ajax({
						type: "GET",		        
						//url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims?page=' + self.page + '&pageSize=10&query%5Binfo.imsi%5D%5B%24regex%5D=',234500003096631 
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/orders?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D='+ago+'&sort=-createdAt&query%5Baction%5D=sendSms',//&query%5BcreatedAt%5D%5B%24lt%5D='+now+'
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if (result.rows.length) {
								//$$('.page-content').removeClass('first_login');
																	
								if(result.page == 1){
									
									self.$app.infiniteScroll.create('.infinite-scroll-content');
									// Loading flag

									self.$setState({
										maxItems: result.total,
										lastItemIndex: $$('.commandsHistoryList li').length,										
									});
								}
							
									// Reset loading flag
									self.$setState({
										allowInfinite: true
									});
								
				
								self.setHistoryList(result.rows);
								
								//if (self.lastItemIndex >= self.maxItems) {
								if (result.page === result.totalPages) {
								  self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
								}
										
								
								
								let incrList = self.lastItemIndex + 10;
								
								self.$setState({
									lastItemIndex: incrList
								});
								
								let incr = self.page + 1;
								
								self.$setState({
									page: incr
								});
									
								//$('.searchbar-hide-on-search').addClass('display-none');
																
								if(self.page == 2){
									$$('.infinite-scroll-content').on('infinite', self.getHistoryList);
								}
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
								self.$setState({
									allowInfinite: true
								});
								self.getReplyList(n);
							
							
								/*self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								$$('.infinite-scroll-preloader').remove();
								self.$app.dialog.alert('There are no history for this period');
								return;*/
								
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});				
			},
			setHistoryList: function (historyList) {
                let self = this;
				
				$.each(historyList, function(index, value){	
					var html = '';
					//console.log(value);
					/*var datetime = moment.utc(value.createdAt).toDate();
						datetime = moment(datetime).format(window.COM_TIMEFORMAT);*/
						var date = moment.utc(value.createdAt).toDate();
						var datetime = date.toISOString();
						var time = date.getDate() + ' ' + self.month_names_short[date.getMonth()] + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getSeconds()).slice(-2);
					var message = '';
					if (value.payload.hasOwnProperty('smsParameters')) {
						if(value.payload.smsParameters.hasOwnProperty('data')){
							if(value.payload.smsParameters.data){
								message = value.payload.smsParameters.data.replace(/</g, "&lt;").replace(/>/g, "&gt;");
							}
						}
					} 

					//if (value.direction == 1) {
					//	html += '<li class="item-content with-divider-bottom" >';
					//} else {
						html += '<li class="item-content" idx="' + index + '" id="sms-id_' + value._id + '">';
					//}
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					//if (value.direction == 'Inbound') {
						//html += '<i class="material-icons md-36">email</i>';
					//} else {
						html += '<i class="material-icons md-36">send</i>';
					//}
						html += '</div>';
						html += '<div class="item-after sms-datetime" date="'+datetime+'">' + time + '</div>';
						html += '</div>';
						html += '<div class="item-text">' + message + '</div>';
						html += '</div>';
						html += '</li>';		
						$$('.commandsHistoryList ul').prepend(html);	
						self.getCallbackList(datetime, index, value._id);
				});
				
			},	
			getReplyList: function (n) {
				
                let self = this;
					if (!self.allowInfinite) return;					
					
				  // Set loading flag
					self.$setState({
                        allowInfinite: false
                    });
					
					var nowFull = moment(); 
					/*var datetime = moment.utc(value.createdAt).toDate();
						datetime = moment(datetime).format(window.COM_TIMEFORMAT);*/
					var start = nowFull.add(-n, 'days');
					var ago = start.toISOString();
					//console.log('https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/messages?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D=' + ago + '&pageSize=10&sort=-createdAt');
					//self.$app.preloader.show();start.format(window.COM_TIMEFORMAT)
					$.ajax({
						type: "GET",		        
						//url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims?page=' + self.page + '&pageSize=10&query%5Binfo.imsi%5D%5B%24regex%5D=',234500003096631 
						//url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/orders?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D='+ago+'&sort=-createdAt&query%5Baction%5D=sendSms',//&query%5BcreatedAt%5D%5B%24lt%5D='+now+'
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/messages?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D=' + ago + '&pageSize=10&sort=-createdAt',
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {//console.log(result);
							if (result.rows.length) {
								//$$('.page-content').removeClass('first_login');
																	
								if(result.page == 1){
									
									self.$app.infiniteScroll.create('.infinite-scroll-content');
									// Loading flag

									self.$setState({
										maxItems: result.total,
										lastItemIndex: $$('.commandsHistoryList li').length,										
									});
								}
							
									// Reset loading flag
									self.$setState({
										allowInfinite: true
									});
								
				
								self.setReplyList(result.rows);
								
								//if (self.lastItemIndex >= self.maxItems) {
								if (result.page === result.totalPages) {
								  self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
								}
										
								
								
								let incrList = self.lastItemIndex + 10;
								
								self.$setState({
									lastItemIndex: incrList
								});
								
								let incr = self.page + 1;
								
								self.$setState({
									page: incr
								});
									
								//$('.searchbar-hide-on-search').addClass('display-none');
																
								if(self.page == 2){
									$$('.infinite-scroll-content').on('infinite', self.getReplyList);
								}
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
							
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								$$('.infinite-scroll-preloader').remove();
								self.$app.dialog.alert('There are no history for this period');
								return;
								
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});				
			},
			setReplyList: function (replyList) {
                let self = this;
				
				var html = '';
				$.each(replyList, function(index, value){	
								
					if(value.status != 'delivered'){
							var date = moment.utc(value.createdAt).toDate();
						var datetime = date.toISOString();
						var time = date.getDate() + ' ' + self.month_names_short[date.getMonth()] + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getSeconds()).slice(-2);
					
					
					if (value.message) {
						value.message = value.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
					}

					//if (value.direction == 1) {
						html += '<li class="item-content with-divider-bottom" ridx="' + index + '">';
					//} else {
						//html += '<li class="item-content" >';
					//}
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					if (value.status == 'delivered') {
						html += '<i class="material-icons md-36">settings</i>';
					} else {
						html += '<i class="material-icons md-36 ">email</i>';
					}
						html += '</div>';
						html += '<div class="item-after ">' + time + '</div>';
						html += '</div>';
					if(value.message){
						html += '<div class="item-text">' + value.message + '</div>';
					}else{
						html += '<div class="item-text">' + value.status + '</div>';
					}
						html += '</div>';
						html += '</li>';		
					}
				});
				
				$$('.commandsHistoryList ul').append(html);	
			},
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;        
				var thisPage = page.$el.find('.page-content'); 

				self.getOldHistory();

				var selectLastDay = $$('select[name="LastDaySelect"]');
				selectLastDay.val(selectLastDay.data("set"));

				var IMSI = thisPage.find('[name="IMSI"]').val();
				var LastDay = thisPage.find('[name="LastDay"]').val();
				
				/*if (IMSI && LastDay) {
					
					self.getCommandHistory({ IMSI: IMSI, LastDay: LastDay });
					//self.requestCommandHistory({ IMSI: IMSI, LastDay: LastDay });
				}

				selectLastDay.on('change', function() {
					self.$setState({
                        allowInfinite: true
                    });
					LastDay = thisPage.find('[name="LastDaySelect"]').val();
					self.getCommandHistory({ IMSI: IMSI, LastDay: LastDay });
					//self.requestCommandHistory({ IMSI: IMSI, LastDay: this.value });
				});*/

			}
		}
    };
</script>
    