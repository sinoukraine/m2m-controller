<!--suppress JSAnnotator -->
<template>
	<div data-name="commands-history" class="page"> <!-- page-with-subnavbar -->
		<!-- Top Navbar -->
		<div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="back link icon-only " >
                        <i class="icon material-icons">arrow_back</i>
                    </a>
                </div>
                <div class="title sliding">
                    Commands History
                </div>
            </div>
        </div>
		
		<div class="page-content ">
			<div class="block searchbar-hide-on-search">
				<h3>{{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG02}}</h3>
                <p>{{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG03}}</p>				
            </div>
			<div class="list">
				<input type="hidden" name="IMSI" value="{{IMSI}}">
				<input type="hidden" name="LastDay" value="1">
			  <ul>
            
                <li class="item-content border_bottom">
                    <div class="item-inner display-block">
                        <div class="item-title label">{{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG06}}</div>
                        <div class="item-input">
                            <select name="LastDaySelect" data-set="{{LastDay}}">                 
								<option value="1">1 day</option>
								<option value="2">3 days</option>
								<option value="7">1 week</option>
								<option value="14">2 weeks</option>
								<option value="14">1 month</option>
								<option value="14">all time</option>
                                <!--<option value="1">1 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG04}}</option>
                                <option value="2">2 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                                <option value="3">3 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                                <option value="4">4 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>
                                <option value="5">5 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="6">6 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option>                                
                                <option value="7">7 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="8">8 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="9">9 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="10">10 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="11">11 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="12">12 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="13">13 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> 
                                <option value="14">14 {{@global.LANGUAGE.ASSET_COMMANDS_HISTORY_MSG05}}</option> -->
                            </select>
                            <i class="f7-icons icon-arrow-drop-down select_arrow"></i>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="list home-list commandsHistoryList">
            <ul>

            </ul>
        </div>
		<div class="preloader infinite-scroll-preloader"></div>
    </div>
</div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				virtualCommandsHistoryList: false,
				allowInfinite: true,
				page: 1,
				lastItemIndex: 0,
				maxItems: 0,
			};            
            
			if (self.$route.query.imsi) {
				ret.IMSI = self.$route.query.imsi;
            }  			
            
            return ret;
        },
		methods: {
			requestCommandHistory: function(params){	
				var self = this;
				if (params && params.IMSI && params.LastDay) {
					var data = {
						IMSI: self.IMSI,
						LastDay: params.LastDay,
					};

					var container = $$('body');
					if (container.children('.progressbar, .progressbar-infinite').length) return; //don't run all this if there is a current progressbar loading
					//App.showProgressbar(container);
					
					$.ajax({
						type: "GET",
						url: API_URL.URL_GET_COMMAND_HISTORY + data.IMSI + '/sms',        
						dataType: "json",	
						headers: { 
							Authorization: "12345"
						},
						async: true,
						cache: false,
						success: function (result) {
							if(result){				
								/*if (result.MajorCode == '000') {.Data && result.Data.length > 0 && virtualCommandsHistoryList*/
									if (result) {
										
										var listEl = self.$el.find('.commandsHistoryList');
										
										if (self.virtualCommandsHistoryList) {
											self.virtualCommandsHistoryList.destroy();
										}
										
										//result.length = 5;
										
										self.virtualCommandsHistoryList = app.virtualList.create({
											el: listEl, 
											items: result,
											height: function(item) {
												var height = 99;
												if (item.direction == 'Inbound') {
													height = 79;
												}
												return height; //display the image with 50px height
											},
											renderItem: function(item, index) {
												var html = '';

												var datetime = moment.utc(item.insertedDate).toDate();
												datetime = moment(datetime).format(window.COM_TIMEFORMAT);


												if (item.message) {
													item.message = item.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
												}

												if (item.direction == 1) {
													html += '<li class="item-content with-divider-bottom" >';
												} else {
													html += '<li class="item-content" >';
												}
												html += '<div class="item-inner item-inner-commands-history">';
												html += '<div class="item-title-row">';
												html += '<div class="item-title">';
												if (item.direction == 'Inbound') {
													html += '<i class="material-icons md-36">email</i>';
												} else {
													html += '<i class="material-icons md-36">send</i>';
												}
												html += '</div>';
												html += '<div class="item-after">' + datetime + '</div>';
												html += '</div>';
												html += '<div class="item-text">' + item.message + '</div>';
												html += '</div>';
												html += '</li>';
												return ret;
											}
										});
										
										//virtualCommandsHistoryList.replaceAllItems(result);
									} else {
										/*App.addNotification({
											hold: 3000,
											message: LANGUAGE.ASSET_COMMANDS_HISTORY_MSG01
										});*/
										if (self.virtualCommandsHistoryList) {
											self.virtualCommandsHistoryList.deleteAllItems();
										}
									}
								/*} else {
									//App.alert(LANGUAGE.PROMPT_MSG013);
								} */
								//console.log(result);
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
				}
			},
			getCommandHistory: function (params) {
                let self = this;
				
				/*var input = $$('.formSearchSim input[name="searchInput"');*/

				//if (input.val()) {
					$$('.commandsHistoryList ul').html('');
				/*	input.blur();

					var searchby = input.data('searchby');

					var data = input.val().trim();
					*/
					self.$setState({
						page: 1
					});
					if (params && params.IMSI && params.LastDay) {
						/*var data = {
							IMSI: self.IMSI,
							LastDay: params.LastDay,
						};*/
						self.getHistoryList(params.LastDay);
						self.$app.infiniteScroll.create('.infinite-scroll-content');	
					}
				//} else {
					/*App.addNotification({
						hold: 3000,
						message: LANGUAGE.PROMPT_MSG008
					});*/
				//}		
			},						
			getCallbackList: function (date, index, curId) {
									
				var nextId = $$('.page').find('.commandsHistoryList ul [idx="' + (index - 1) + '"]').attr('id');
				var nextDate = $$('.page').find('.commandsHistoryList ul [idx="' + (index - 1) + '"] .sms-datetime').html();	
				
				var curDate = date.slice(0,10).toString();
				
				if(nextDate == undefined) {
					var d = new Date();
					var m_names = new Array("01", "02", "03", 
					"04", "05", "06", "07", "08", "09", 
					"10", "11", "12"); 
					
					var today = d.getDate()+1; 
					var curr_month = d.getMonth();
					var curr_year = d.getFullYear();
					nextDate = curr_year + "-" + m_names[curr_month] + "-" + today;
				}else{
					nextDate = nextDate.slice(0,10).toString();
				}				
				
                let self = this;
					//self.$app.preloader.show();
					$.ajax({
						type: "GET",		        
						//url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims?page=' + self.page + '&pageSize=10&query%5Binfo.imsi%5D%5B%24regex%5D=',234500003096631 
						//url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/orders?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D=2020-02-14&query%5BcreatedAt%5D%5B%24lt%5D=2020-02-15',' + data + '
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/messages?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D=' + curDate + '&pageSize=500&sort=createdAt&query%5BcreatedAt%5D%5B%24lt%5D=' + nextDate,
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if (result.rows) {
								self.setCallbackList(result.rows, curId);
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
								App.alert(LANGUAGE.PROMPT_MSG013);
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});				
			},
			setCallbackList: function (callbackList, curId) {
                let self = this;
				// Generate new items HTML
				var html = '';
				$.each(callbackList, function(index, value){	//console.log(value);
					//console.log(value);
					var datetime = moment.utc(value.createdAt).toDate();
						datetime = moment(datetime).format(window.COM_TIMEFORMAT);
					
					//var datearr[index] = datetime;
					
					//var prevDate = $$('.page').find('.commandsHistoryList ul [ridx="' + (index - 1) + '"] .sms-datetime').html();
					/*if(index){						
						var prevDate = callbackList[index-1].createdAt.slice(0,10).toString();
						var currDate = callbackList[index].createdAt.slice(0,10).toString();						
						var p = new Date(prevDate);
						var c = new Date(currDate);
						var prev_date = p.getDate();		
						var prev_month = p.getMonth();
						var prev_year = p.getFullYear();
						var curr_date = c.getDate();		
						var curr_month = c.getMonth();
						var curr_year = c.getFullYear();
						
						if(prev_year + "-" + prev_month + "-" + prev_date != curr_year + "-" + curr_month + "-" + curr_date){
							html += '<li class="item-content with-divider-bottom" >';				
							html += '<div class="item-inner item-inner-commands-history">';
							html += '<div class="item-title-row">';
							html += '<div class="item-title">';	
							html += '</div>';
							html += '<div class="item-after sms-datetime" style="font-weight: bolder">' + curr_year + "/" + curr_month + "/" + curr_date + '</div>';					
							html += '</div>';
							html += '</div>';
							html += '</li>';	
						}
					}*/
					
					if (value.message) {
						value.message = value.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
					}

					//if (value.direction == 1) {
						html += '<li class="item-content with-divider-bottom" ridx="' + index + '">';
					//} else {
						//html += '<li class="item-content" >';
					//}
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					if (value.status == 'delivered') {
						html += '<i class="material-icons md-36">settings</i>';
					} else {
						html += '<i class="material-icons md-36 ">email</i>';
					}
						html += '</div>';
						html += '<div class="item-after sms-datetime">' + datetime + '</div>';
						html += '</div>';
					if(value.message){
						html += '<div class="item-text">' + value.message + '</div>';
					}else{
						html += '<div class="item-text">' + value.status + '</div>';
					}
						html += '</div>';
						html += '</li>';		
						
				});
				
				$('#sms-id_' + curId).after(html);		
			
		},
			getHistoryList: function (n) {
				
				var d = new Date();
				var m_names = new Array("01", "02", "03", 
					"04", "05", "06", "07", "08", "09", 
					"10", "11", "12");
					
				var today = d.getDate();  //change day here
				var nDaysAgo = d.getDate()-n;  //change day here
				var curr_month = d.getMonth();
				var curr_year = d.getFullYear();
				var ago = curr_year + "-" + m_names[curr_month] + "-" + nDaysAgo;
				var now = curr_year + "-" + m_names[curr_month] + "-" + today;
						
                let self = this;
					if (!self.allowInfinite) return;					
					
				  // Set loading flag
					self.$setState({
                        allowInfinite: false
                    });
					
					//self.$app.preloader.show();
					$.ajax({
						type: "GET",		        
						//url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims?page=' + self.page + '&pageSize=10&query%5Binfo.imsi%5D%5B%24regex%5D=',234500003096631 
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/nomad/orders?query%5Bimsi%5D=' + self.IMSI + '&query%5BcreatedAt%5D%5B%24gt%5D='+ago+'&sort=createdAt',//&query%5BcreatedAt%5D%5B%24lt%5D='+now+'
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {console.log(result);
							if (result.rows.length) {
								//$$('.page-content').removeClass('first_login');
																	
								if(result.page == 1){
									
									self.$app.infiniteScroll.create('.infinite-scroll-content');
									// Loading flag

									self.$setState({
										maxItems: result.total,
										lastItemIndex: $$('.commandsHistoryList li').length,										
									});
								}
							
									// Reset loading flag
									self.$setState({
										allowInfinite: true
									});
								
				
								self.setHistoryList(result.rows);
								
								//if (self.lastItemIndex >= self.maxItems) {
								if (result.page === result.totalPages) {
								  self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
								}
										
								
								
								let incrList = self.lastItemIndex + 10;
								
								self.$setState({
									lastItemIndex: incrList
								});
								
								let incr = self.page + 1;
								
								self.$setState({
									page: incr
								});
									
								//$('.searchbar-hide-on-search').addClass('display-none');
																
								if(self.page == 2){
									$$('.infinite-scroll-content').on('infinite', self.getHistoryList);
								}
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								$$('.infinite-scroll-preloader').remove();
								self.$app.dialog.alert('There are no history for this period');
								return;
								
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});				
			},
			setHistoryList: function (historyList) {
                let self = this;
				// Generate new items HTML
				var html = '';
					/*
						html += '<li class="item-content" idx="0" id="sms-id_5e46d802344b03443d5762d4">';
					
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					//if (value.direction == 'Inbound') {
						//html += '<i class="material-icons md-36">email</i>';
					//} else {
						html += '<i class="material-icons md-36">send</i>';
					//}
						html += '</div>';
						html += '<div class="item-after sms-datetime">2020-02-14T18:25:22.872Z</div>';
						html += '</div>';
						html += '<div class="item-text">test 2</div>';
						html += '</div>';
						html += '</li>';	
								
					html += '<li class="item-content" idx="1" id="sms-id_5e46d802344b03443d5762d3">';
					
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					//if (value.direction == 'Inbound') {
						//html += '<i class="material-icons md-36">email</i>';
					//} else {
						html += '<i class="material-icons md-36">send</i>';
					//}
						html += '</div>';
						html += '<div class="item-after sms-datetime">2020-02-13T18:25:22.872Z</div>';
						html += '</div>';
						html += '<div class="item-text">test 1</div>';
						html += '</div>';
						html += '</li>';
						*/
				$.each(historyList, function(index, value){	
					//console.log(value);
					var datetime = moment.utc(value.createdAt).toDate();
						datetime = moment(datetime).format(window.COM_TIMEFORMAT);

					var message = '';
					if (value.payload.smsParameters.data) {
						message = value.payload.smsParameters.data.replace(/</g, "&lt;").replace(/>/g, "&gt;");
					} 

					//if (value.direction == 1) {
					//	html += '<li class="item-content with-divider-bottom" >';
					//} else {
						html += '<li class="item-content" idx="' + index + '" id="sms-id_' + value._id + '">';
					//}
						html += '<div class="item-inner item-inner-commands-history">';
						html += '<div class="item-title-row">';
						html += '<div class="item-title">';
					//if (value.direction == 'Inbound') {
						//html += '<i class="material-icons md-36">email</i>';
					//} else {
						html += '<i class="material-icons md-36">send</i>';
					//}
						html += '</div>';
						html += '<div class="item-after sms-datetime">' + datetime + '</div>';
						html += '</div>';
						html += '<div class="item-text">' + message + '</div>';
						html += '</div>';
						html += '</li>';		
						self.getCallbackList(value.createdAt, index, value._id);
				});
				
				
				// Append new items
				$$('.commandsHistoryList ul').prepend(html);	
						//self.getCallbackList('2020-02-14T17:25:22.872Z', '0', 'sms-id_5e46d802344b03443d5762d4');
						//self.getCallbackList('2020-02-13T16:25:22.872Z', '1', 'sms-id_5e46d802344b03443d5762d3');	
			},	
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;        
				var thisPage = page.$el.find('.page-content'); 

				

				var selectLastDay = $$('select[name="LastDaySelect"]');
				selectLastDay.val(selectLastDay.data("set"));

				var IMSI = thisPage.find('[name="IMSI"]').val();
				var LastDay = thisPage.find('[name="LastDay"]').val();
				
				if (IMSI && LastDay) {
					
					self.getCommandHistory({ IMSI: IMSI, LastDay: LastDay });
					//self.requestCommandHistory({ IMSI: IMSI, LastDay: LastDay });
				}

				selectLastDay.on('change', function() {
					self.$setState({
                        allowInfinite: true
                    });
					LastDay = thisPage.find('[name="LastDaySelect"]').val();
					self.getCommandHistory({ IMSI: IMSI, LastDay: LastDay });
					//self.requestCommandHistory({ IMSI: IMSI, LastDay: this.value });
				});

			}
		}
    };
</script>
    