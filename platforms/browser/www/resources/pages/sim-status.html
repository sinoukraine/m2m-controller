<!--suppress JSAnnotator -->
<template>
	<div data-name="sim-status" class="page"> <!-- page-with-subnavbar -->
		<!-- Top Navbar -->
		<div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="back link icon-only " >
                        <i class="icon material-icons">arrow_back</i>
                    </a>
                </div>
                <div class="title sliding">
                    SIM Status
                </div>
                <div class="right">
                    <a href="#" class="link icon-only openSettings" >
                        <i class="material-icons md-36">settings</i>
                    </a>
                </div>
            </div>
        </div>
		
		<div class="page-content">
			<div class="inner-content">
				<div class="sim-status-top">
					<img class="sim-icon" src="./resources/images/sim.svg" alt="main">
					<div class="sim-status-top-info">
						<div class="text-content">IMSI: {{IMSI}}</div>
						<div class="text-content">ICCID: {{ICCID}}</div>
					</div>
				</div>
				<div class="content-block status_block_top">
					<div class="row no-gutter status_block_icons">
						<div class="col-33 ">
							<img src="resources/images/data.svg" alt="">
							<p>{{dataInfo}} MB</p>
						</div>                
						<div class="col-33">
							<img src="resources/images/date.svg" alt="">
							<p>{{dateInfo}}</p>
							
						</div> 
						<div class="col-33">
							<img src="resources/images/messages.svg" alt="">
							<p>{{messagesInfo}}</p>                    
						</div>               
					</div>
				</div>
				
				
				
				<div class="list no-y-margin mb-5" >
					<ul><!-- class="item-inner" class="additional-sim-info-ul"
						<li class="item-content additional-sim-info">
							<div class="item-media"></div>
							<div class="item-title label additional-sim-label">Customer</div>
							<div class="item-input dflex item-input-field">
								<div class="item-title label">Ag Tracking</div>
								<i class="material-icons md-36 select_arrow">arrow_drop_down</i>
							</div>
						</li>-->
						<!--<li class="item-content additional-sim-info">
							<a href="#" class="currentState">
								<div class="item-media"></div>
								<div class="item-title label additional-sim-label">State</div>
								<div class="item-input dflex item-input-field">
									<div class="item-title label">{{statusInfo}}</div>
									<i class="material-icons md-36 select_arrow">arrow_drop_down</i>
								</div>
							</a>
						</li>-->
						<!-- Default Setup -->
						<li class="state-block display-none">
						  <a class="item-link smart-select smart-select-0 smart-select-init ">
							<select name="sim-state">
							  <option value="Productive" id="state-1">Active</option>
							  <option value="Suspended" id="state-2">Suspend</option>
							</select>
							<div class="item-content">
							  <div class="item-inner">
								<div class="item-title">State</div>
							  </div>
							</div>
						  </a>
						</li>
						<li class="state-block display-none">
						  <a class="item-link smart-select smart-select-1 smart-select-init ">
							<select name="sim-state" class="list home-list customerList">
							  
							  {{#each customers}}
                                <option value="{{val}}" data-display-as="{{displayAs}}" {{#if selected}} selected {{/if}}>{{name}}</option>
                                {{/each}}
							</select>
							<div class="item-content">
							  <div class="item-inner">
								<div class="item-title">Customer</div>
							  </div>
							</div>
						  </a>
						</li>
						<li>
							<div class="text-editor-content" style="margin: 15px;padding-bottom: 15px; " contenteditable></div>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="location-div display-none">
			<button class="col button button-outline currentLocation" >Show location</button>
		</div>
    </div>
</template>

<script>
  // script must return component object
    return { 
        data: function () {
            var self = this;
            var ret = {
				obj: {},
				//Description: '',
				lat: '0',
				lng: '0',
				dataInfo: 0,
				dateInfo: 0,
				virtualCustomerList: false,
				messagesInfo: 0,
				statusInfo: '',
				customers: [],
				selectedCustomer: 'uui'
			};         
			
            if (self.$route.query.id) {
				ret.ID = self.$route.query.id;
            }  		
			
			if (self.$route.query.imsi) {
				ret.IMSI = self.$route.query.imsi;
            }  			
            
			if (self.$route.query.iccid) {
				ret.ICCID = self.$route.query.iccid;
            }  			
            return ret;
        },
		methods: {
			getSim: function (payload) {
			
				var self = this;				
				
				$.ajax({
						type: "GET",		        
						url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims/'+ self.ID, 
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){							
								//console.log(result);	
								self.obj = result;
								/*self.$setState({
									Description: result.info.description
								});*/
								payload.html(result.info.description);							
							
								if (self.obj.ancestors.length > 0) {
									self.getCustomerName(self.obj.ancestors[0]);
								}
								/*var listEl1 = self.$el.find('.smart-select-1');
								
								if (self.obj.ancestors.length > 0) {
									let cName; 
									let cIdx = self.customers.findIndex(x => x.val === self.obj.ancestors[0]);
										
									if (cIdx !== -1) {
										cName = self.customers[cIdx].name;								
										listEl1.find('.item-after').html(cName);
									}
								}*/
				
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
			},
			
			getCustomerName: function(id){	
				var self = this;
				
				var listEl1 = self.$el.find('.smart-select-1');
				
								
										$.ajax({	        
											url: 'https://m2mdata03.sinopacific.com.ua/em/v3/counterparties/'+id, 
											dataType: "json",	
											async: true,
											method: "GET",
											headers: {
												"authorization": "12345",
												"content-type": "application/json"
											},
											success: function (result) {
												if(result){							
													//console.log(result);	
													
													listEl1.find('.item-after').html(result.info.name);
													
													
												}else{
													console.log('something wrong');
												}
											},
											error: function(XMLHttpRequest, textStatus, errorThrown){
												console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
											}
										});
										
										
									
			},
			requestCustomerList: function(){	
				var self = this;
				self.$app.preloader.hide();
			
					var listEl = self.$el.find('.customerList');
									
										
				self.virtualCustomerList = self.$app.virtualList.create({
                    el: listEl,
                    items : [],
                    
                    height: function(item){
                        let height = 65.33;
                       
                        return height;
                    },
                    renderItem: function (item, index) {
									console.log(item);
									let html = '';
									
									//if(item._id != '5e8b317230479466a7d87127'){									
									html += '<option value="'+item._id+'" id="'+item._id+'">'+item.info.name+'</option>';
									//}
									return html;
						
					}
				});
				
				
										
										
										$.ajax({
											//type: "PUT",		        
											url: 'https://m2mdata03.sinopacific.com.ua/em/v3/counterparties', 
											dataType: "json",	
											async: true,
											//cache: false,						
											//data: JSON.stringify(data),
											method: "GET",
											headers: {
												"authorization": "12345",
												"content-type": "application/json"
											},
											success: function (result) {
												if(result){							
													//console.log(result);	
													
													//self.virtualCustomerList.replaceAllItems(result.rows);
													var array = [];
													result.rows.forEach(function(value, index){
														array.push({
															val: value._id,
															displayAs: value.info.name,
															name: value.info.name,
														});
														
													//array[0].selected = true;
													/*	
													var listEl1 = self.$el.find('.smart-select-1');
													listEl1.find('.item-after').html(value.info.name);
													*/
											

														console.log(array[0]);														
													});													
													
													self.$setState({
														customers: array,
													});	
													
													
												}else{
													console.log('something wrong');
												}
											},
											error: function(XMLHttpRequest, textStatus, errorThrown){
												console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
											}
										});
										
										
									
			},
			saveSim: function (payload) {
			
				var self = this;				
				var data = { 
					'info' : self.obj.info,
					'settings' : self.obj.settings,
					'ancestors' : self.obj.ancestors,
					'tags' : self.obj.tags					
				};
				
				data.info.description = payload;
				
				$.ajax({
						//type: "PUT",		        
						url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims/'+ self.ID, 
						dataType: "json",	
						async: true,
						//cache: false,						
						data: JSON.stringify(data),
						method: "PUT",
						headers: {
							"authorization": "12345",
							"content-type": "application/json"
						},
						success: function (result) {
							if(result){							
								console.log(result);	
								
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
			},
			loadTrackPage: function () {
			
				var self = this;
				
				$.ajax({
						type: "GET",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI + '/coordinates?formula=centerOfMass', 
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
							
								//console.log(result);
								var lat = result.geometry.coordinates[0], lng = result.geometry.coordinates[1];
								
								self.$setState({
									lat: result.geometry.coordinates[0],
									lng: result.geometry.coordinates[1],
								});		
								
								$('.location-div').removeClass('display-none');
								//$$('.location-div .currentLocation').removeAttr('disabled');								 
								
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
			},
			initSimInfo: function () {
                let self = this;
									
					$.ajax({
						type: "GET",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI + '/sms', 
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
								var dates = [];
								
								$.each(result, function(index, value){										
									dates.push(new Date(value.insertedDate));
								});
									
								var maxDate = new Date(Math.max.apply(null, dates));
								var maxDate = moment.utc(maxDate).toDate();
									maxDate = moment(maxDate).format(window.COM_TIMEFORMAT);
													
								self.$setState({
									dateInfo: maxDate.substr(0, maxDate.length - 6).replace("T", " "),
								});	
								
								self.$setState({
									messagesInfo: result.length,
								});		
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
					$.ajax({
						type: "GET",		        
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/cdrs/'+ self.IMSI, 
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if(result){
								var total = 0;
								
								$.each(result, function(index, value){										
									var mb = 0;
									if(value.totals != null && value.totals.data != null && value.totals.data.originalUnits != null){
										mb = value.totals.data.originalUnits;
									}
									total = total + mb;
								});
								
								self.$setState({
									dataInfo: (total/1000000).toFixed(3),
								});
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
					$.ajax({
						type: "GET",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI, 
						dataType: "json",	
						async: true,
						//cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) { 
							if(result){			
								
								let setStatus = '';
				
								switch(result.status){
									case 'Productive':					
										setStatus = 'Productive';						
									break;
									default:					
										setStatus = 'Suspended';									
								}
								
								self.smartSelect.setValue(setStatus);
								$('.state-block').removeClass('display-none');
								
								self.$setState({
									statusInfo: setStatus
								});

								//console.log(result.status);
							  
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
            },
			setNewState: function (state) {
                let self = this;
				
				if(self.statusInfo != state){
				
					var data = {
						"offer": "M2M Data",
						"offerOptions": {},
					}
					let setStatus = '';
					
					switch(state){
						case 'Productive':			
							if(self.statusInfo == 'Suspended'){
								setStatus = '/resume';
							}else{
								setStatus = '/activate';
							}							
						break;
						case 'Suspended':					
							setStatus = '/suspend';
						break;
					}
									
					console.log(API_URL.URL_GET_COMMAND_HISTORY + self.IMSI + setStatus);
					$.ajax({
						type: "PUT",		        
						url: API_URL.URL_GET_COMMAND_HISTORY + self.IMSI + setStatus, 
						dataType: "json",	
						async: true,
						//cache: false,
						data: JSON.stringify(data),
						headers: {
							"authorization": "12345",
							"content-type": "application/json"
						},
						success: function (result) {
								//console.log(result);
							if(result){		
								self.$setState({
									statusInfo: state
								});
								//self.$app.dialog.alert('Button1 clicked')
								self.notificationFull.open();
							}else{
								//console.log('something wrong');
								self.$setState({
									statusInfo: self.statusInfo
								});
								self.$app.dialog.alert('Something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							self.$setState({
									statusInfo: self.statusInfo
								});
							self.$app.dialog.alert('Something wrong');
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
				}
			},	
		setNewCustomerState: function (state) {
                let self = this;
				
				//if(self.customerId != state){
				
				var data = { 
					'info' : self.obj.info,
					'settings' : self.obj.settings,
					'ancestors' : self.obj.ancestors,
					'tags' : self.obj.tags					
				};
				
				/*if(data.ancestors.indexOf(state)!=-1){
					data.ancestors.push(state);
				}else if(data.ancestors.lenght){*/
					data.ancestors.pop(state);
					data.ancestors.push(state);
				//}
				$.ajax({	        
						url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims/'+ self.ID, 
						dataType: "json",	
						async: true,					
						data: JSON.stringify(data),
						method: "PUT",
						headers: {
							"authorization": "12345",
							"content-type": "application/json"
						},
						success: function (result) {
							if(result){			
								
							}else{
								console.log('something wrong');
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
						}
					});
					
					
				//},
				
		},	
		},
        on: {
            pageInit: function (e, page) {  
				var self = this;        
				self.$app.preloader.show();
				
				self.requestCustomerList();
							
				var placeholder = '<span class="placeholder">Description</span>';
				
				var textarea = page.$el.find('.text-editor-content');
				textarea.html(placeholder);				
				
				self.getSim(textarea);	
				
				textarea.on('click', function(){
					$(this).find('.placeholder').remove();
				});
				
				textarea.on('blur', function(){
					if(!$(this).html()) {
						$(this).html(placeholder);
					}else{
						var data = $(this).html().replace(/(<([^>]+)>)/ig,"");
						self.saveSim(data);
					}
				});
															
				var boatMarker = L.icon({
					iconUrl: 'resources/images/marker.svg',                       
					//iconSize:     [50, 50], // size of the icon                        
					//iconAnchor:   [50, 99], // point of the icon which will correspond to marker's location                        
					//popupAnchor:  [0, -50] // point from which the popup should open relative to the iconAnchor    
					iconSize:     [50, 50], // size of the icon                        
					//iconAnchor:   [50, 99], // point of the icon which will correspond to marker's location    
					iconAnchor:   [17, 55],
					popupAnchor:  [0, -50] // point from which the popup should open relative to the iconAnchor   
				});				

				self.loadTrackPage();
				
				var dynamicPopup = self.$app.popup.create({
								  content: '<div class="page popup-tablet-fullscreen popup">'+
										'<div class="page-content">'+
										'	<div class="position_map "> '+
										'		<div class="map" id="map"></div>'+
										'	</div>'+
										'</div>'+
									'</div>',
								  on: {
									open: function (popup) {									
									  //console.log('Popup open');
										
				//	
										
										if (self.lat !== 0 && parseFloat(self.lng) !== 0) {            
										
											var marker = L.marker([self.lat, self.lng], {icon: boatMarker}); 
											marker.setLatLng([self.lat, self.lng]);
											MapTrack = Protocol.Helper.createMap({ target: 'map', latLng: [self.lat,self.lng], zoom: 14 });        
											marker.addTo(MapTrack);
											
											//self.$app.preloader.hide();
										}else{
											self.$app.dialog.alert('Currently there are no coordinates for this IMSI. Please try again later');
											dynamicPopup.close();
										}
										
									},
									opened: function (popup) {
									  //console.log('Popup opened');
									},
								  }
								});
								
								
								
					
						var listEl = self.$el.find('.smart-select-0');
								
						self.smartSelect = self.$app.smartSelect.create({
							el: listEl,
						  on: {
							opened: function () {
							  //console.log('Smart select opened');		
							  //console.log(self.smartSelect.getValue());
							},
							closed: function () {
							  //console.log('Smart select closed');
							  //console.log(self.smartSelect.getValue());
							  self.setNewState(self.smartSelect.getValue());
							}
						  }
						});	
						
						var listEl1 = self.$el.find('.smart-select-1');
								
						self.smartSelect1 = self.$app.smartSelect.create({
							el: listEl1,
						  on: {
							opened: function () {
							  //console.log('Smart select opened');		
							  //console.log(self.smartSelect.getValue());
							},
							closed: function () {
							  //console.log('Smart select closed');
							  //console.log(self.smartSelect.getValue());
							  
								let cName; 
								let cIdx = self.customers.findIndex(x => x.val === self.smartSelect1.getValue());
								
								console.log(self.customers);
								if (cIdx !== -1) {
									cName = self.customers[cIdx].name;
								}
							  listEl1.find('.item-after').html(cName);
							  self.setNewCustomerState(self.smartSelect1.getValue());
							}
						  }
						});	

						
								
				self.notificationFull = self.$app.notification.create({
								  //icon: '<i class="icon demo-icon">7</i>',
								  title: 'M2M Data Controller',
								  //titleRightText: 'now',
								  subtitle: 'SIM State Notification',
								  text: 'State was changed successfully',
								  closeTimeout: 3000,
								});
				
				

				
					 
				
				var thisPage = page.$el.find('.page-content'); 			

                self.initSimInfo();
				self.$app.preloader.hide();
				
				$('.currentState').on('click', function(){						
					mainView.router.navigate('/set-status/?imsi='+self.IMSI);
				});
				
				$('.openSettings').on('click', function(){						
					mainView.router.navigate('/settings/?id='+self.ID);
				});
				
				$('.currentLocation').on('click', function(){		
					
					//self.$app.dialog.alert('Showing location in development')
					//self.$app.preloader.show();
					dynamicPopup.open();
							
				});
				
				
				
			}
		}
    };
</script>
    