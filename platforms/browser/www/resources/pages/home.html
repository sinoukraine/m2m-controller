<!--suppress JSAnnotator -->
<template>
    <div class="page " data-name="home"> <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="/panel-left/" class="link icon-only " >
                        <i class="icon material-icons">menu</i>
                    </a>
                </div>
                <div class="title sliding">
                    {{@global.LANGUAGE.HOME_MSG00}}
                </div>
                <div class="right">
                    <a href="#" class="link icon-only scanBarCode">
                        <i class="f7-icons icon-other-barcode"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="toolbar tabbar toolbar-top">
            <div class="toolbar-inner">
                <!-- Links have "tab-link" class instead of just "link" to switch tabs -->
                <a @click="FilterSimList" data-type="imsi" href="#tab1" class="tab-link tab-link-active">IMSI</a>
                <a @click="FilterSimList" data-type="iccid" href="#tab2" class="tab-link" >ICCID</a>
            </div>
        </div>

        <form class="searchbar custom-searchbar formSearchSim">
            <div class="searchbar-inner">
				
				  <label class="toggle toggle-init color-blue dirrect-search-toggle">
					<input type="checkbox" class="dirrectSearch">
					<span class="toggle-icon"></span>
				  </label>
                <div class="searchbar-input-wrap">
                    <input type="search" name="searchInput" class="search-sims" placeholder="{{placeholderSearch}}" title="{{@global.LANGUAGE.COM_MSG002}}">
                    <!--<i class="searchbar-icon"></i>-->
                    <span class="input-clear-button"></span>
                    <button type="submit" class="button search-sims-btn"><i class="material-icons">search</i></button>
                </div>
                <!--<span class="searchbar-disable-button">{{@global.LANGUAGE.COM_MSG001}}</span>-->
            </div>
        </form>

        <div class="page-content  infinite-scroll-content infinite-scroll-bottom data-infinite-distance">
	
            <!--fake tabs for tabbar correct working working-->
            <div class="tabs">
                <div class="tab-active" id="tab1"></div>
                <div id="tab2"></div>
            </div>

            <div class="searchbar-backdrop"></div>

            <div class="block searchbar-not-found">
                <div class="block-inner">{{@global.LANGUAGE.PROMPT_MSG000}}</div>
            </div>

            <div class="block searchbar-hide-on-search">
                <p>In this screen, you can find the device by IMSI or ICCID. You can use the "scan" icon to determine the ICCID number.</p>
            </div>
			
            <div class="list home-list virtual-list media-list no-hairlines no-chevron no-margin-top searchbar-found simList">
                <!-- keep it empty -->
				<ul>
			  </ul>
            </div>

			<div class="preloader infinite-scroll-preloader"></div>
        </div>

		<p><a href="#" data-actions=".my-actions" class="actions-open">Open Actions</a></p>

    </div>
</template>

<script>
    // script must return component object
    return {
        data: function () {
            let ret = {
				toggleValue: false,
				placeholderSearch: 'BETA Search',
				text: '',
				type: 'imsi',
				allowInfinite: true,
				page: 1,
				ac5: null,
				lastItemIndex: 0,
				maxItems: 0
			};

            return ret;
        },
        methods: {
			submitSearchForm: function (type) { 
                let self = this;
				var input = $$('.formSearchSim input[name="searchInput"');

				//if (input.val()) {
					$$('.simList ul').html('');
					input.blur();

					var searchby = input.data('searchby');

					var data = input.val().trim();
					
					self.$setState({
						text: data,
						type: type,
						page: 1
					});
					
					if(self.toggleValue){
						console.log('dri');
						self.getSim();
					}else{
						self.getSimList();
						self.$app.infiniteScroll.create('.infinite-scroll-content');	
					}
				//} else {
					/*App.addNotification({
						hold: 3000,
						message: LANGUAGE.PROMPT_MSG008
					});*/
				//}		
			},				
			getSim: function () {
                let self = this;
					
					if(!self.text){
						self.$app.dialog.alert('Please fill search field.');
						self.$setState({
										allowInfinite: true
									});
								
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
					}
					//self.$app.preloader.show();
					$.ajax({
						type: "GET",		        
						//url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims?query%5Binfo.' + self.type + '%5D%5B%24regex%5D=' + self.text,
						//url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims?page=' + self.page + '&pageSize=10&query%5B' + self.type + '%5D%5B%24regex%5D=' + self.text,
						url: 'https://m2mdata03.sinopacific.com.ua/m2mdata/v3/sims/' + self.text,
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							console.log(result);
							if (result) {
								//$$('.page-content').removeClass('first_login');
								var html = '';
								
								html += '<li>';
								html += '<a href="#" data-imsi="'+result.imsi+'" data-iccid="'+result.iccId+'" class="ac-5 item-link item-content">';
								html += '  <div class="item-inner">';
								html += '   <div class="item-title-row">';
								html += '   <div class="item-title color-custom">';
								html += '     <div class="display-flex">';
								html += '       <div class="prop-name">IMSI:</div>';
								html += '             <div class="imsi-value">'+result.imsi+'</div>';
								html += '              </div>';
								html += '              </div>';
								html += '               <div class="item-after color-custom"><i class="f7-icons icon-other-menu3 color-m2m-blue" style="font-size:20px;margin-top:5px;"></i></div>';
								html += '               </div>';
								html += '                 <div class="item-text">';
								html += '                         <div class="display-flex">';
								html += '                                <div class="prop-name">ICCID:</div>';
								html += '                           <div class="iccid-value">'+result.iccId+'</div>';
								html += '                    </div>';
								html += '               <div class="display-flex">';
								html += '              <div class="prop-name">MSISDN:</div>';
								html += '                         <div class="uppercase">'+result.msisdn+'</div>';
								html += '                         </div>';
								html += '                   <div class="display-flex">';
								html += '                      <div class="prop-name">Rag:</div>';
								html += '						<div style="font-size: 14px;color: #CD3333;">&#11044;</div>';
								html += '          			</div>';
								html += '            </div>';
								html += '             </div>';
								html += '               </a>';
								html += '               </li>';
							
											
							// Append new items
							$$('.simList ul').append(html);							
									
							}else{
								self.$app.dialog.alert('Incorrect IMSI number.');
							}
							
							self.$setState({
										allowInfinite: true
									});
								
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
								self.$app.dialog.alert('Incorrect IMSI number.');
								
								self.$setState({
										allowInfinite: true
									});
								
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
						}
					});	
			},															
			getSimList: function () {
                let self = this;
					if (!self.allowInfinite) return;					
					
				  // Set loading flag
					self.$setState({
                        allowInfinite: false
                    });
					
					//self.$app.preloader.show();
					$.ajax({
						type: "GET",		        
						url: 'https://m2mdata03.sinopacific.com.ua/em/v3/sims?page=' + self.page + '&pageSize=10&query%5Binfo.' + self.type + '%5D%5B%24regex%5D=' + self.text,
						dataType: "json",	
						async: true,
						cache: false,
						headers: { 
							Authorization: "12345"
						},
						success: function (result) {
							if (result.total) {
								//$$('.page-content').removeClass('first_login');
																	
								if(result.page == 1){
									
									self.$app.infiniteScroll.create('.infinite-scroll-content');
									// Loading flag

									self.$setState({
										maxItems: result.total,
										lastItemIndex: $$('.simList li').length,										
									});
								}
							
									// Reset loading flag
									self.$setState({
										allowInfinite: true
									});
								
								self.setSimList(result.rows);
								
								//if (self.lastItemIndex >= self.maxItems) {
								if (result.page === result.totalPages) {
								  self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
								}
										
								
								
								let incrList = self.lastItemIndex + 10;
								
								self.$setState({
									lastItemIndex: incrList
								});
								
								let incr = self.page + 1;
								
								self.$setState({
									page: incr
								});
									
								$('.searchbar-hide-on-search').addClass('display-none');
																
								if(self.page == 2){
									$$('.infinite-scroll-content').on('infinite', self.getSimList);
								}
										
								if (result.rows.length === 0) {
									/*App.addNotification({
										hold: 3000,
										message: LANGUAGE.PROMPT_MSG006
									});*/
								}
							} else {
								//App.alert(LANGUAGE.PROMPT_MSG013);
								self.$app.dialog.alert('No one IMSI found with this number. Please try with direct search.');
								// Reset loading flag
									self.$setState({
										allowInfinite: true
									});
								
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
							}
							//self.$app.preloader.hide();
							
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							console.log('can not connect: txt = '+textStatus+' err = '+errorThrown);
								self.$app.dialog.alert('Something wrong.');
							self.$app.infiniteScroll.destroy('.infinite-scroll-content');
							self.$setState({
										allowInfinite: true
									});
								
								self.$app.infiniteScroll.destroy('.infinite-scroll-content');
								  
								  // Remove preloader
								  $$('.infinite-scroll-preloader').remove();
								  return;
						}
					});				
			},
			setSimList: function (simList) {
                let self = this;
				// Generate new items HTML
				var html = '';
				
				$.each(simList, function(index, value){	
					html += '<li>';
                    html += '<a href="#" data-imsi="'+value.info.imsi+'" data-iccid="'+value.info.iccid+'" class="ac-5 item-link item-content">';
                    html += '  <div class="item-inner">';
                    html += '   <div class="item-title-row">';
                    html += '   <div class="item-title color-custom">';
                    html += '     <div class="display-flex">';
                    html += '       <div class="prop-name">IMSI:</div>';
                    html += '             <div class="imsi-value">'+value.info.imsi+'</div>';
                    html += '              </div>';
                    html += '              </div>';
                    html += '               <div class="item-after color-custom"><i class="f7-icons icon-other-menu3 color-m2m-blue" style="font-size:20px;margin-top:5px;"></i></div>';
                    html += '               </div>';
                    html += '                 <div class="item-text">';
					html += '                         <div class="display-flex">';
					html += '                                <div class="prop-name">ICCID:</div>';
                    html += '                           <div class="iccid-value">'+value.info.iccid+'</div>';
                    html += '                    </div>';
                    html += '               <div class="display-flex">';
                    html += '              <div class="prop-name">MSISDN:</div>';
                    html += '                         <div class="uppercase">'+value.info.msisdn+'</div>';
                    html += '                         </div>';
                    html += '                   <div class="display-flex">';
                    html += '                      <div class="prop-name">Rag:</div>';
					html += '						<div style="font-size: 14px;color: #CD3333;">&#11044;</div>';
                    html += '          			</div>';
                    html += '            </div>';
                    html += '             </div>';
					html += '               </a>';
					html += '               </li>';
				});
								
				// Append new items
				$$('.simList ul').append(html);		
			},	
            FilterSimList: function (e) {
                let self = this;
                let filterType = $$(e.target).closest('.tab-link').data('type');				
				self.submitSearchForm(filterType);
            },
			openBarCodeReader: function(input) {
				let self = this;
				//console.log(input);
				if (window.device && cordova.plugins && cordova.plugins.barcodeScanner) {
					cordova.plugins.barcodeScanner.scan(
						function(result) {
							/*self.$app.dialog.alert("We got a barcode\n" +
								  "Result: " + result.text + "\n" +
								  "Format: " + result.format + "\n" +
								  "Cancelled: " + result.cancelled);*/
							if (result && result.text) {console.log();
								input.val(result.text);
								if(input.attr('name') == 'searchInput') {
									self.submitSearchForm(self.type);
								}
								input.change(); // fix to trigger onchange / oninput event listener
							}

						},
						function(error) {
							self.$app.dialog.alert("Scanning failed: " + error);
						}, {
							//preferFrontCamera : true, // iOS and Android
							showFlipCameraButton: true, // iOS and Android
							showTorchButton: true, // iOS and Android
							torchOn: true, // Android, launch with the torch switched on (if available)
							//saveHistory: true, // Android, save scan history (default false)
							prompt: "Place a barcode inside the scan area", // Android
							resultDisplayDuration: 0, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
							//formats : "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
							//orientation : "landscape", // Android only (portrait|landscape), default unset so it rotates with the device
							//disableAnimations : true, // iOS
							//disableSuccessBeep: false // iOS and Android
						}
					);
				} else {
					self.$app.dialog.alert('Your device does not support this function');
				}
			}
        },
        on: {
            pageInit: function (e, page) {
                let self = this;
				
				self.submitSearchForm(self.type);
				$$('body').on('submit', '.formSearchSim', function(e) {
					e.preventDefault();
					self.submitSearchForm(self.type);
					return false;
				});
				$$('body').on('click', '.searchSim', function() {
					self.submitSearchForm(self.type);
				});
				
				$$('body').on('click', '.simList .item-inner', function() {
					var parrent = $$(this).closest('.item-content');
					var imsi = parrent.attr('data-imsi');
					var iccid = parrent.attr('data-iccid');

					var notificationsCheck = '';
					if (parrent.data('notifications') == 1) {
						notificationsCheck = 'checked="checked"';
					}


					var commands = '<div class="action_button_wrapper">' +
						'<div class="action_button_block action_button_media">' +
						'<i class="f7-icons icon-other-commands commands-icon color-m2m-blue"></i>' +
						'</div>' +
						'<div class="action_button_block action_button_text color-m2m-grey">' +
						'Commands' +
						'</div>' +
						'</div>';

					var commandsHistory = '<div class="action_button_wrapper">' +
						'<div class="action_button_block action_button_media">' +
						'<i class="material-icons md-36 color-m2m-blue">watch_later</i>' +
						'</div>' +
						'<div class="action_button_block action_button_text color-m2m-grey">' +
						'History' +
						'</div>' +
						'</div>';


					var SIMStatus = '<div class="action_button_wrapper">' +
						'<div class="action_button_block action_button_media">' +
						'<i class="material-icons md-36 color-m2m-blue">info</i>' +
						'</div>' +
						'<div class="action_button_block action_button_text color-m2m-grey">' +
						'SIM Status' +
						'</div>' +
						'</div>';

					var buttons = [{
							text: 'IMSI: '+ imsi,
							label: true,
							color: 'blue',
						},
						{
							text: commands,
							onClick: function() {
								//loadPageCommands();
								mainView.router.navigate('/commands/?imsi='+imsi.toString());
							},
						},
						{
							text: commandsHistory,
							onClick: function() {
								mainView.router.navigate('/commands-history/?imsi='+imsi.toString());;
							},
						},
						{
							text: SIMStatus,
							onClick: function() {
								mainView.router.navigate('/sim-status/?imsi='+imsi.toString()+'&iccid='+iccid.toString());
							},
						},
					];

					self.$app.actions.create({buttons}).open();
				});
				
				$$('body').on('click', '.scanBarCode', function() {
					//let input = $$('body').find('.searchInput');//$$(this).siblings('input');
					var input = $$('.formSearchSim input[name="searchInput"');

					let permissions = cordova.plugins.permissions;
					if (!permissions) {
						self.$app.dialog.alert('plugin not supported')
					} else {
						permissions.hasPermission(permissions.CAMERA, function(status) {
							// App.alert(JSON.stringify(status))

							if (status.hasPermission) {
								self.openBarCodeReader(input);
							} else {
								permissions.requestPermission(permissions.CAMERA, success, error);

								function error() {
									self.$app.dialog.alert('Camera permission is not turned on');
								}

								function success(status1) {
									self.openBarCodeReader(input);
									if (!status1.hasPermission) error();
								}
							}
						});

					}
				});		
				
				var toggle = app.toggle.create({
				  el: '.toggle',
				  on: {
					change: function () {
						if(toggle.checked){
							self.$setState({
								toggleValue: true,
								placeholderSearch: 'Direct search'
							});
						}else{
							self.$setState({
								toggleValue: false,
								placeholderSearch: 'BETA search'
							});
						}						
					}
				  }
				})			
				
            },
            pageAfterIn:function(){

            },
            pageBeforeOut:function(){
			
            },
            pageBeforeRemove: function () {
               									 
            },
        }
    };
</script>